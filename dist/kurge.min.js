!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";var e,t;e=void 0,t=function(){var o,e,u="data-kgid",h=Math.random().toString(36).substr(2),a={key:!0,ref:!0},t=Object.keys(window||{}).filter(function(e){return/^on/.test(e)}),v={};t.forEach(function(e){return v[e]=!0}),(e=o||(o={}))[e.EVENT=0]="EVENT",e[e.ANIMATION=1]="ANIMATION",e[e.TASK=2]="TASK",e[e.NORMAL=3]="NORMAL";var w=new(function(){function e(){this.listeners={}}return e.prototype.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.emit=function(e){if(this.listeners[e]){for(var t=0;t<this.listeners[e].length;t++)this.listeners[e][t]();this.clean(e)}},e.prototype.clean=function(e){delete this.listeners[e]},e}()),n=0,r=function(){function e(e){this.id=n++,this.depIds={},this.newDepIds={},this.list=[],this.newList=[],this.instance=e}return e.prototype.depend=function(e){var t=e.id;this.newDepIds[t]||(this.newDepIds[t]=!0,this.newList.push(e),this.depIds[t]||e.subscribe(this))},e.prototype.clean=function(){for(var e,t,n=this.list.length;n--;){var r=this.list[n];this.newDepIds[r.id]||r.unsubscribe(this)}e=[this.newDepIds,this.depIds],this.depIds=e[0],this.newDepIds=e[1],this.newDepIds={},t=[this.newList,this.list],this.list=t[0],this.newList=t[1],this.newList.length=0},e.prototype.update=function(){b.enqueueSetState(this.instance)},e}(),i=0,l=function(){function e(e){void 0===e&&(e=null),this.id=i++,this.list=[],this.specificWatcher=e}return e.prototype.subscribe=function(e){this.list.push(e)},e.prototype.unsubscribe=function(e){!function(e,t){if(e.length){var n=e.indexOf(t);if(-1<n)e.splice(n,1)}}(this.list,e)},e.prototype.collect=function(){e.target&&(!this.specificWatcher||this.specificWatcher&&this.specificWatcher===e.target)&&e.target.depend(this)},e.prototype.notify=function(){for(var e=0;e<this.list.length;e++)this.list[e].update()},e.target=null,e}(),s=[];function c(e){s.push(e),l.target=e}function f(){s.pop(),l.target=s[s.length-1]}var d=function(){function e(e){this.refs={},this.watcher=new r(this),this.guards=[],this.guardLeft=0,this.states=[],this.stateId=0,this.element=e,this.component=this.element.type}return Object.defineProperty(e.prototype,"key",{get:function(){return this.element&&null!=this.element.key?"k_"+this.element.key:null!=this.index?""+this.index:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"node",{get:function(){return this.renderedInstance?this.renderedInstance.node:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentState",{get:function(){return this.states[this.stateId++]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"prevGuard",{get:function(){if(this.guardLeft)return this.guardLeft--,this.guards.shift()},enumerable:!0,configurable:!0}),e.prototype.mount=function(e){c(this.watcher),this.renderedInstance=S(this.component(this.element.props));var t=this.renderedInstance.mount(this.id=e);return f(),this.watcher.clean(),t},e.prototype.same=function(e){return j.object(e)&&e.type===this.element.type&&e.key===this.element.key},e.prototype.update=function(e){if(this.node){e=null==e?this.element:e;var t=!0;j.function(this.component.shouldUpdate)&&(t=this.component.shouldUpdate(this.element.props,e.props)),t&&(this.stateId=0,this.guardLeft=this.guards.length,c(this.watcher),b.enqueueUpdate(this.renderedInstance,this.component(e.props)),f(),this.watcher.clean()),this.element=e}},e.prototype.unmount=function(){w.emit("unmount:"+this.id),this.renderedInstance.unmount(),this.watcher.clean(),delete this.id,delete this.index,delete this.guards,delete this.guardLeft,delete this.states,delete this.stateId,delete this.refs,delete this.watcher,delete this.element,delete this.component,delete this.renderedInstance},e}(),p=function(){function e(){this.arr=[]}return Object.defineProperty(e.prototype,"current",{get:function(){return this.arr[0]&&this.arr[0].current},enumerable:!0,configurable:!0}),e.prototype.insert=function(e,t){var n=!1,r=e.id;if(this.arr.length)for(var i=0;i<this.arr.length;i++)if(this.arr[i].id===r){this.arr[i]={id:r,priority:t,current:[{instance:e,element:null}]},n=!0;break}n||this.arr.push({id:r,priority:t,current:[{instance:e,element:null}]}),this.arr.sort(function(e,t){return e.priority-t.priority})},e.prototype.shift=function(){return this.arr.shift()},e}(),b=new(function(){function e(){this.dirtyList=new p,this.isBatchUpdating=!1,this.priority=o.NORMAL}return e.prototype.enqueueSetState=function(e){this.dirtyList.insert(e,this.priority),this.isBatchUpdating||this.runBatchUpdate()},e.prototype.enqueueUpdate=function(e,t){this.dirtyList.current.push({instance:e,element:t})},e.prototype.runBatchUpdate=function(){var r=this;this.isBatchUpdating=!0;var n=function(e){for(var t=function(){if(r.dirtyList.current.length){var e=r.dirtyList.current.shift(),t=e.instance,n=e.element;t.id&&(t.update(n),t instanceof d&&w.on("updated",function(){t.node&&w.emit("updated:"+t.id)}))}else r.dirtyList.shift()};0<e.timeRemaining()&&r.dirtyList.current;)t();r.dirtyList.current?O(n):r.isBatchUpdating=!1,w.emit("updated")};O(n)},e}());window._requestAnimationFrame=window.requestAnimationFrame,window.requestAnimationFrame=function(e){return window._requestAnimationFrame(function(){b.priority=o.ANIMATION,e.apply(this,arguments),b.priority=o.NORMAL})},window._setTimeout=window.setTimeout,window.setTimeout=function(e,t){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return j.string(e)&&(e=new Function(e)),(n=window)._setTimeout.apply(n,[function(){b.priority=o.TASK,e.apply(this,arguments),b.priority=o.NORMAL},t].concat(r))},window._setInterval=window.setInterval,window.setInterval=function(e,t){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return j.string(e)&&(e=new Function(e)),(n=window)._setInterval.apply(n,[function(){b.priority=o.TASK,e.apply(this,arguments),b.priority=o.NORMAL},t].concat(r))};var y=Object.prototype.toString,j={undefined:function(e){return"[object Undefined]"===y.call(e)},null:function(e){return"[object Null]"===y.call(e)},number:function(e){return"[object Number]"===y.call(e)},string:function(e){return"[object String]"===y.call(e)},boolean:function(e){return"[object Boolean]"===y.call(e)},symbol:function(e){return"[object Symbol]"===y.call(e)},regexp:function(e){return"[object RegExp]"===y.call(e)},object:function(e){return"[object Object]"===y.call(e)},array:function(e){return"[object Array]"===y.call(e)},function:function(e){return"[object Function]"===y.call(e)}},m=Object.prototype.hasOwnProperty;function g(e,t){return m.call(e,t)}var O=window.requestIdleCallback||function(e){var t=Date.now();return requestAnimationFrame(function(){e({timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})})};function k(e){return Object.getPrototypeOf(e)||e.__proto__||null}function x(e){return function(){b.priority=o.EVENT,e.apply(this,arguments),b.priority=o.TASK}}function I(e){return document.querySelector("["+u+'="'+e+'"]')}function E(e){if(""===e)return document.createTextNode("");var t=document.createElement("div");return t.innerHTML=e,t.firstChild}function L(t){var e="";return null==t||("object"==typeof t?e+=Object.keys(t).filter(function(e){return t[e]}).join(" "):Array.isArray(t)?e+=t.join(" "):e+=t.toString()),e.trim()}function A(e){var t="";if(null==e);else if("object"==typeof e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t+=n.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()})+": "+e[n]+"; ");else t+=e.toString();return t.trim()}var N=function(){function e(e){this.node=null,this.element=""+e}return Object.defineProperty(e.prototype,"key",{get:function(){return null!=this.index?""+this.index:null},enumerable:!0,configurable:!0}),e.prototype.mount=function(e){var t=this;return this.id=e,w.on("loaded",function(){var e=I(t.id);e&&(t.node=e.firstChild,t.node||(t.node=E("")),e.parentNode.insertBefore(t.node,e),e.remove())}),"<span "+u+'="'+e+'" >'+this.element+"</span>"},e.prototype.same=function(e){return j.number(e)||j.string(e)},e.prototype.update=function(e){this.node&&(e=null==e?this.element:""+e,this.element!==e&&(this.element=e,this.node.textContent=this.element))},e.prototype.unmount=function(){this.node&&this.node.remove(),delete this.id,delete this.node,delete this.index,delete this.element},e}();var P=function(){function e(e){this.node=null,this.element=e}return Object.defineProperty(e.prototype,"key",{get:function(){return this.element&&null!=this.element.key?"k_"+this.element.key:null!=this.index?""+this.index:null},enumerable:!0,configurable:!0}),e.prototype.mount=function(r){var i=this;this.id=r,w.on("loaded",function(){return i.node=I(i.id)});var o="<"+this.element.type+" "+u+'="'+r+'" ';null!=this.element.key&&(o+='key="'+this.element.key+'" ');var t=this.element.props,e=function(e){if("children"===e)return"continue";"className"===e?o+='class="'+L(t.className)+'" ':"style"===e?o+='style="'+A(t.style)+'" ':v[e.toLowerCase()]&&j.function(t[e])?w.on("loaded",function(){i.node[e.toLowerCase()]=x(t[e])}):o+=e+'="'+t[e]+'" '};for(var n in t)e(n);if(o+=">",this.childInstances=[],this.element.props.children.forEach(function(e,t){var n=S(e);n.index=t,o+=n.mount(r+":"+n.key),i.childInstances.push(n)}),o+="</"+this.element.type+">",j.string(this.element.ref)&&l.target){var s=l.target.instance;w.on("loaded",function(){return s.refs[i.element.ref]=i.node})}return w.on("loaded",function(){i.node&&i.node.removeAttribute(u)}),o},e.prototype.same=function(e){return j.object(e)&&e.type===this.element.type&&e.key===this.element.key},e.prototype.update=function(e){if(this.node){e=null==e?this.element:e;var t=this.node,n=this.element.props,r=e.props;for(var i in r)if("children"!==i)if("className"===i){var o=L(r.className);t.className!==o&&(t.className=o)}else if("style"===i){var s=A(r.style);t.style.cssText!==s&&(t.style.cssText=s)}else if("value"===i){var u=r.value;t.value!==u&&(t.value=u)}else if(v[i.toLowerCase()]&&j.function(r[i])){var a=r[i];this.node[i.toLowerCase()]!==a&&(this.node[i.toLowerCase()]=x(a))}else{var l=r[i];t.getAttribute(i)!==l&&t.setAttribute(i,l)}for(var i in n)(j.undefined(r[i])||j.null(r[i]))&&(v[i.toLowerCase()]&&j.function(r[i])?delete this.node[i.toLowerCase()]:t.removeAttribute("className"!==i?i:"class"));var c,f,d,h,p,y,m=this.childInstances,g=e.props.children;1===m.length&&1===g.length&&m[0].same(g[0])?b.enqueueUpdate(m[0],g[0]):(c=this,f=function(e,t){var o={};e.forEach(function(e){return o[e.key]=e});var s=[];t.forEach(function(e,t){var n=null!=e.key?"k_"+e.key:""+t,r=o[n];if(r&&r.same(e))b.enqueueUpdate(r,e),s.push(r);else{var i=S(e);s.push(i)}});for(var n=[],r=[],i=-1,u=e.length,a=0;a<s.length;a++){var l=s[a],c=o[l.key];c===l?(c.index<i&&n.push({type:"move",inst:c,index:i}),i=Math.max(c.index,i)):(c&&n.push({type:"remove",inst:c}),n.push({type:"insert",inst:l,index:i}));var f=s[s.length-a-1],d=o[f.key];d===f?(d.index>u&&r.push({type:"move",inst:d,index:u}),u=Math.min(d.index,u)):(d&&r.push({type:"remove",inst:d}),r.push({type:"insert",inst:f,index:u}))}var h={};for(var p in s.forEach(function(e){h[e.key]&&console.warn("Find duplicate keys in a list. Please offer unique keys for list items or rendering this list may meet some error"),h[e.key]=e}),o)h[p]||(n.push({type:"remove",inst:o[p]}),r.push({type:"remove",inst:o[p]}));return s.forEach(function(e,t){return e.index=t}),e.length=0,e.push.apply(e,s),n.length<r.length?{ops:n,dir:"forward"}:{ops:r,dir:"backward"}}(m,g),d=c.node,h=f.ops,p=f.dir,y=0,h.forEach(function(e){var t="forward"===p?e.index+1+y:e.index;if("remove"===e.type)e.inst.unmount();else if("insert"===e.type){y++;var n=E(e.inst.mount(c.id+":"+e.inst.key)),r=d.children[t];d.insertBefore(n,r),w.emit("loaded"),w.emit("mounted")}else n=e.inst.node,r=d.children[t],d.insertBefore(n,r)})),this.element=e}},e.prototype.unmount=function(){this.childInstances.forEach(function(e){return e.unmount()}),this.node&&this.node.remove(),delete this.id,delete this.node,delete this.index,delete this.element,delete this.childInstances},e}();function _(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i={children:[].concat.apply([],n)},o=null,s=null;if(t)for(var u in null!=t.key&&(o=(""+t.key).replace(/:/g,"_")),t.ref&&j.string(t.ref)&&(s=t.ref),t)g(t,u)&&!a[u]&&(i[u]=t[u]);return{type:e,key:o,ref:s,props:i}}function S(e){var t=null;if(j.undefined(e)||j.null(e)||j.number(e)||j.string(e))t=new N(e);else if(j.string(e.type))t=new P(e);else{if(!j.function(e.type))throw new Error("illegal VDOM node type, please do not return array/null/undefined/etc in an app");t=new d(e)}return t}var T=["push","pop","shift","unshift","splice","sort","reverse"],M=function(a,l){var e=j.array(a),c={};function f(s){if(e&&-1<T.indexOf(s)){var u=l.get(a,s,c);return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];switch(s){case"push":case"unshift":for(var n=0;n<e.length;n++){(j.object(e[n])||j.array(e[n]))&&(e[n]=D(e[n],l.get(a,h,c).specificWatcher));var r=l.get(a,"length",c)+n;Object.defineProperty(c,r,{configurable:!0,enumerable:!0,get:f.bind(a,r),set:d.bind(a,r)})}break;case"pop":case"shift":delete c[l.get(a,"length",c)-1];break;case"splice":var i=e[1];for(n=2;n<e.length;n++)(j.object(e[n])||j.array(e[n]))&&(e[n]=D(e[n],l.get(a,h,c).specificWatcher));for(n=0;n<i;n++)delete c[l.get(a,"length",c)-1-n]}var o=u.apply(a,e);return l.get(a,h,c).notify(),o}}return l.get(a,s,c)}function d(e,t){l.set(a,e,t,c)}for(var t,n,r=Object.create(null),i=a;i;)Object.getOwnPropertyNames(i).forEach(function(e){if(!r[e]){var t=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(c,e,{configurable:t.configurable,enumerable:t.enumerable,get:f.bind(a,e),set:d.bind(a,e)}),r[e]=!0}}),i=k(i);return t=c,n=k(a),Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__&&(t.__proto__=n),c};window.Proxy||console.warn("Proxy isn't natively supported, and Kurge will use built-in polyfill instead");var q=window.Proxy||M,C=window.Reflect||{get:function(e,t){return e[t]},set:function(e,t,n){return e[t]=n,!0},deleteProperty:function(e,t){return delete e[t]}};function D(e,r){if(void 0===r&&(r=null),j.function(e))throw new Error("function can't be observed");for(var t in j.object(e)||j.array(e)||(e={value:e}),e)g(e,t)&&(j.object(e[t])||j.array(e[t]))&&(e[t]=D(e[t],r));var i=new l(r);return new q(e,{get:function(e,t){return t===h?i:(g(e,t)&&i.collect(),C.get(e,t))},set:function(e,t,n){return(g(e,t)||j.undefined(e[t]))&&n!==e[t]&&(!j.object(n)&&!j.array(n)||n[h]||(n=D(n,r)),i.notify()),C.set(e,t,n)},deleteProperty:function(e,t){return g(e,t)&&i.notify(),C.deleteProperty(e,t)}})}return{version:"1.1.1",render:function(e,t){if(l.target)throw new Error("please call render outside all components");if(!j.object(e))throw new Error("please offer a legal VDOM node");if(!t)throw new Error("a root DOM node is needed to mount the app");var n=E((j.string(e.type)?S(_(function(){return e})):S(e)).mount("kg"));t.parentNode.insertBefore(n,t),t.remove(),w.emit("loaded"),w.emit("mounted")},createElement:_,createContext:function(e){if(l.target)throw new Error("please call createContext outside all components");return D(e)},useState:function(e){if(l.target){var t=l.target.instance;t.node||t.states.push(D(e,l.target));var n=t.currentState;if(n)return n;throw new Error("unmatch any states. please don't call useState in if/loop statement")}throw new Error("please call useState at top level in a component")},useRefs:function(){if(l.target)return l.target.instance.refs;throw new Error("please call useRefs at top level in a component")},useEffect:function(t,e){if(void 0===e&&(e=null),!j.null(e)&&!j.array(e))throw new Error("the second argument of useEffect only accepts array");if(!l.target)throw new Error("please call useEffect at top level in a component");var n=l.target.instance;if(n.node){var r=n.prevGuard;if(j.undefined(r))throw new Error("unmatch any effects. please don't call useEffect in if/loop statement");var i=!1;if(j.array(e)&&j.array(r)&&e.length===r.length)for(var o=0;o<e.length;o++)e[o]!==r[o]&&(i=!0);else i=!0;i&&w.on("updated:"+n.id,function(){w.clean("unmount:"+n.id);var e=t();e&&j.function(e)&&w.on("unmount:"+n.id,e)})}else w.on("mounted",function(){if(n.node){var e=t();e&&j.function(e)&&w.on("unmount:"+n.id,e)}});n.guards.push(e)}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Kurge=t()});
