!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";var e,t;e=void 0,t=function(){var t=Object.prototype.toString,k={undefined:function(e){return"[object Undefined]"===t.call(e)},null:function(e){return"[object Null]"===t.call(e)},number:function(e){return"[object Number]"===t.call(e)},string:function(e){return"[object String]"===t.call(e)},boolean:function(e){return"[object Boolean]"===t.call(e)},symbol:function(e){return"[object Symbol]"===t.call(e)},regexp:function(e){return"[object RegExp]"===t.call(e)},object:function(e){return"[object Object]"===t.call(e)},array:function(e){return"[object Array]"===t.call(e)},function:function(e){return"[object Function]"===t.call(e)}},n=Object.prototype.hasOwnProperty;function a(e,t){return n.call(e,t)}var i=requestAnimationFrame;var s="data-kgid",r=Math.random().toString(36).substring(2),l={key:!0,ref:!0},x=/^on/,e=Object.keys(window||{}).filter(function(e){return x.test(e)}),u=e.map(function(e){return e.replace(x,"")}),j={};e.forEach(function(e){return j[e]=!0});var c=/[:]\w+$/;function E(e){return document.querySelector("["+s+'="'+e+'"]')}function I(e){if(""===e)return document.createTextNode("");var t=document.createElement("div");return t.innerHTML=e,t.firstChild}function L(t){var e="";return null==t||("object"==typeof t?e+=Object.keys(t).filter(function(e){return t[e]}).join(" "):Array.isArray(t)?e+=t.join(" "):e+=t.toString()),e.trim()}function U(e){var t="";if(null==e);else if("object"==typeof e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t+=n.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()})+": "+e[n]+"; ");else t+=e.toString();return t.trim()}var B=new(function(){function e(){this.listeners={}}return e.prototype.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.emit=function(e,t){if(void 0===t&&(t=!1),this.listeners[e])if(t)for(var n=this.listeners[e].length-1;-1<n;n--)this.listeners[e][n]();else for(n=0;n<this.listeners[e].length;n++)this.listeners[e][n]()},e.prototype.clean=function(e){delete this.listeners[e]},e}()),o=function(){function e(e){this.node=null,this.element=""+e}return Object.defineProperty(e.prototype,"key",{get:function(){return null!=this.index?""+this.index:null},enumerable:!0,configurable:!0}),e.prototype.mount=function(e){var t=this;return this.id=e,B.on("mounted:refs",function(){var e=E(t.id);t.node=e.firstChild,e.parentNode.insertBefore(t.node,e),e.remove()}),"<span "+s+'="'+e+'" >'+this.element+"</span>"},e.prototype.same=function(e){return k.number(e)||k.string(e)},e.prototype.update=function(e){e=k.undefined(e)||k.null(e)?this.element:""+e,this.element!==e&&(this.element=e,this.node.textContent=this.element)},e.prototype.unmount=function(){this.node.remove(),delete this.id,delete this.index,delete this.element},e}(),h=function(){function e(e){this.arr=[],this.compare=e}return Object.defineProperty(e.prototype,"length",{get:function(){return this.arr.length},enumerable:!0,configurable:!0}),e.prototype.push=function(e){this.arr.push(e),this.promote(this.arr.length-1)},e.prototype.shift=function(){var e;return 1<this.arr.length?(e=this.arr[0],this.arr[0]=this.arr.pop(),this.heapify(0)):e=this.arr.pop(),e},e.prototype.heapify=function(e){var t,n=this.left(e),r=this.right(e),i=e;this.arr[n]&&this.compare(this.arr[n],this.arr[e])&&(i=n),this.arr[r]&&this.compare(this.arr[r],this.arr[e])&&(i=r),i!==e&&(t=[this.arr[i],this.arr[e]],this.arr[e]=t[0],this.arr[i]=t[1],this.heapify(i))},e.prototype.promote=function(e){for(var t,n=this.parent(e);this.arr[n]&&this.compare(this.arr[n],this.arr[e]);)t=[this.arr[n],this.arr[e]],this.arr[e]=t[0],this.arr[n]=t[1],e=n,n=this.parent(e)},e.prototype.parent=function(e){return Math.floor((e+1)/2)-1},e.prototype.left=function(e){return 2*(e+1)-1},e.prototype.right=function(e){return 2*(e+1)},e}(),f=0,p=function(){function e(e){this.id=f++,this.depIds={},this.newDepIds={},this.list=[],this.newList=[],this.instance=e}return e.prototype.depend=function(e){var t=e.id;this.newDepIds[t]||(this.newDepIds[t]=!0,this.newList.push(e),this.depIds[t]||e.subscribe(this))},e.prototype.clean=function(){for(var e,t,n=this.list.length;n--;){var r=this.list[n];this.newDepIds[r.id]||r.unsubscribe(this)}e=[this.newDepIds,this.depIds],this.depIds=e[0],this.newDepIds=e[1],this.newDepIds={},t=[this.newList,this.list],this.list=t[0],this.newList=t[1],this.newList.length=0},e.prototype.update=function(){M.enqueueUpdate(this.instance)},e}(),d=0,m=function(){function e(){this.id=d++,this.list=[]}return e.prototype.subscribe=function(e){this.list.push(e)},e.prototype.unsubscribe=function(e){!function(e,t){if(e.length){var n=e.indexOf(t);if(-1<n)e.splice(n,1)}}(this.list,e)},e.prototype.collect=function(){e.target&&e.target.depend(this)},e.prototype.notify=function(){for(var e=0;e<this.list.length;e++)this.list[e].update()},e.target=null,e}(),y=[];function v(e){y.push(e),m.target=e}function g(){y.pop(),m.target=y[y.length-1]}var O=function(){function e(e){this.state=null,this.node=null,this.refs={},this.watcher=new p(this),this.element=e,this.component=this.element.type}return Object.defineProperty(e.prototype,"key",{get:function(){return this.element&&null!=this.element.key?"k_"+this.element.key:null!=this.index?""+this.index:null},enumerable:!0,configurable:!0}),e.prototype.mount=function(e){var t=this;v(this.watcher),this.renderedInstance=C(this.component(this.element.props));var n=this.renderedInstance.mount(this.id=e);return g(),this.watcher.clean(),B.on("mounted:refs",function(){return t.node=E(t.id)}),n},e.prototype.same=function(e){return k.object(e)&&e.type===this.element.type&&e.key===this.element.key},e.prototype.update=function(e){e=null==e?this.element:e,v(this.watcher),M.enqueueUpdate(this.renderedInstance,this.component(e.props)),g(),this.watcher.clean(),this.element=e},e.prototype.unmount=function(){B.emit("before-unmount:"+this.id),this.renderedInstance.unmount(),this.watcher.clean(),delete this.index,delete this.state,delete this.refs,delete this.watcher,delete this.element,delete this.component,delete this.renderedInstance,B.emit("unmounted:"+this.id),B.clean("before-update:"+this.id),B.clean("updated:"+this.id),B.clean("before-unmount:"+this.id),B.clean("unmounted:"+this.id),delete this.id},e}(),w=function(){function e(){this.map={},this.arr=new h(function(e,t){return e.split(":").length>t.split(":").length})}return Object.defineProperty(e.prototype,"length",{get:function(){return this.arr.length},enumerable:!0,configurable:!0}),e.prototype.push=function(e){var t=e.instance.id;this.map[t]||this.arr.push(t),this.map[t]=e},e.prototype.shift=function(){var e=this.arr.shift(),t=this.map[e];return delete this.map[e],t},e}(),M=new(function(){function e(){this.dirtyInstanceSet=new w,this.isBatchUpdating=!1}return e.prototype.enqueueUpdate=function(e,t){void 0===t&&(t=null),this.dirtyInstanceSet.push({instance:e,element:t}),this.isBatchUpdating||this.runBatchUpdate()},e.prototype.runBatchUpdate=function(){var r=this;this.isBatchUpdating=!0,i(function(){for(var e=function(){var e=r.dirtyInstanceSet.shift(),t=e.instance,n=e.element;t.id&&(t instanceof O&&B.emit("before-update:"+t.id),t.update(n),t instanceof O&&B.on("updated",function(){return B.emit("updated:"+t.id)}))};r.dirtyInstanceSet.length;)e();r.isBatchUpdating=!1,B.emit("updated",!0),B.clean("updated")})},e}());var _=new(function(){function e(){var o=this;this._eventListeners={},document&&u.forEach(function(i){document.addEventListener(i,function(e){for(var t,n=e.target.getAttribute&&e.target.getAttribute(s);n;){var r=o._eventListeners[n]&&o._eventListeners[n][i];r&&r(e),t=n,n=c.test(t)&&t.replace(c,"")}})})}return e.prototype.get=function(e,t){return this._eventListeners[e][t]},e.prototype.set=function(e,t,n){this._eventListeners[e]||(this._eventListeners[e]={}),this._eventListeners[e][t]=n},e.prototype.remove=function(e,t){this._eventListeners[e]&&delete this._eventListeners[e][t]},e.prototype.clean=function(e){delete this._eventListeners[e]},e}()),b=function(){function e(e){this.node=null,this.element=e}return Object.defineProperty(e.prototype,"key",{get:function(){return this.element&&null!=this.element.key?"k_"+this.element.key:null!=this.index?""+this.index:null},enumerable:!0,configurable:!0}),e.prototype.mount=function(r){var i=this;this.id=r;var o="<"+this.element.type+" "+s+'="'+r+'" ';null!=this.element.key&&(o+='key="'+this.element.key+'" ');var e=this.element.props;for(var t in e)"children"!==t&&("className"===t?o+='class="'+L(e.className)+'" ':"style"===t?o+='style="'+U(e.style)+'" ':j[t.toLowerCase()]&&k.function(e[t])?_.set(r,t.toLowerCase().replace(x,""),e[t]):o+=t+'="'+e[t]+'" ');if(o+=">",this.childInstances=[],this.element.props.children.forEach(function(e,t){var n=C(e);n.index=t,o+=n.mount(r+":"+n.key),i.childInstances.push(n)}),o+="</"+this.element.type+">",B.on("mounted:refs",function(){return i.node=E(i.id)}),k.string(this.element.ref)&&m.target){var n=m.target.instance;B.on("mounted:refs",function(){return n.refs[i.element.ref]=i.node})}return o},e.prototype.same=function(e){return k.object(e)&&e.type===this.element.type&&e.key===this.element.key},e.prototype.update=function(e){e=null==e?this.element:e;var t=this.node,n=this.element.props,r=e.props;for(var i in r)if("children"!==i)if("className"===i){var o=L(r.className);t.className!==o&&(t.className=o)}else if("style"===i){var s=U(r.style);t.style.cssText!==s&&(t.style.cssText=s)}else if("value"===i){var u=r.value;t.value!==u&&(t.value=u)}else if(j[i.toLowerCase()]&&k.function(r[i])){var a=i.toLowerCase().replace(x,""),l=_.get(this.id,a),c=r[i];l!==c&&_.set(this.id,a,c)}else{var h=r[i];t.getAttribute(i)!==h&&t.setAttribute(i,h)}for(var i in n)(k.undefined(r[i])||k.null(r[i]))&&(j[i.toLowerCase()]&&k.function(r[i])?_.remove(this.id,i.toLowerCase().replace(x,"")):t.removeAttribute("className"!==i?i:"class"));var f,p,d,m,y,v,g=this.childInstances,w=e.props.children;if(1===g.length&&1===w.length&&g[0].same(w[0]))M.enqueueUpdate(g[0],w[0]);else{var b=function(e,t){var o={};e.forEach(function(e){return o[e.key]=e});var s=[];t.forEach(function(e,t){var n=null!=e.key?"k_"+e.key:""+t,r=o[n];if(r&&r.same(e))r instanceof O||M.enqueueUpdate(r,e),s.push(r);else{var i=C(e);s.push(i)}});for(var n=[],r=[],i=-1,u=e.length,a=0;a<s.length;++a){var l=s[a],c=o[l.key];c===l?(c.index<i&&n.push({type:"move",inst:c,index:i}),i=Math.max(c.index,i)):(c&&n.push({type:"remove",inst:c}),n.push({type:"insert",inst:l,index:i}));var h=s[s.length-a-1],f=o[h.key];f===h?(f.index>u&&r.push({type:"move",inst:f,index:u}),u=Math.min(f.index,u)):(f&&r.push({type:"remove",inst:f}),r.push({type:"insert",inst:h,index:u}))}var p={};for(var d in s.forEach(function(e){p[e.key]&&console.warn("Find duplicate keys in a list. Please offer unique keys for list items or rendering this list may meet some error"),p[e.key]=e}),o)p[d]||(n.push({type:"remove",inst:o[d]}),r.push({type:"remove",inst:o[d]}));return s.forEach(function(e,t){return e.index=t}),e.length=0,e.push.apply(e,s),n.length<r.length?{ops:n,dir:"forward"}:{ops:r,dir:"backward"}}(g,w);f=this.id,p=b,d=E(f),m=p.ops,y=p.dir,v=0,m.forEach(function(e){var t="forward"===y?e.index+1+v:e.index;if("remove"===e.type)e.inst.unmount();else if("insert"===e.type){++v;var n=I(e.inst.mount(f+":"+e.inst.key)),r=d.children[t];d.insertBefore(n,r),B.emit("mounted:refs"),B.emit("mounted"),B.clean("mounted:refs"),B.clean("mounted")}else n=e.inst.node,r=d.children[t],d.insertBefore(n,r)})}this.element=e},e.prototype.unmount=function(){_.clean(this.id),this.childInstances.forEach(function(e){return e.unmount()}),this.node.remove(),delete this.id,delete this.index,delete this.element,delete this.childInstances},e}();function S(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i={children:n=n.length?[].concat.apply([],n):[""]},o=null,s=null;if(t)for(var u in null!=t.key&&(o=(""+t.key).replace(/:/g,"_")),t.ref&&k.string(t.ref)&&(s=t.ref),t)a(t,u)&&!l[u]&&(i[u]=t[u]);return{type:e,key:o,ref:s,props:i}}function C(e){var t=null;if(k.undefined(e)||k.null(e)||k.number(e)||k.string(e))t=new o(e);else if(k.string(e.type))t=new b(e);else{if(!k.function(e.type))throw new Error("illegal VDOM node type, please do not return array/null/undefined/etc in an app");t=new O(e)}return t}function N(e){if(!k.object(e)&&!k.array(e))throw new Error("observed data must be object or array");var i=new m;return new Proxy(e,{get:function(e,t,n){return t===r?e:(a(e,t)&&m.target&&i.collect(),Reflect.get(e,t,n))},set:function(e,t,n,r){return(a(e,t)||k.undefined(e[t]))&&n!==e[t]&&i.notify(),Reflect.set(e,t,n,r)},deleteProperty:function(e,t){return a(e,t)&&i.notify(),Reflect.deleteProperty(e,t)}})}return{render:function(e,t){if(!k.object(e))throw new Error("please offer a legal VDOM node");if(!t)throw new Error("a root DOM node is needed to mount the app");var n=I((k.string(e.type)?C(S(function(){return e})):C(e)).mount("kg"));t.parentNode.insertBefore(n,t),t.remove(),B.emit("mounted:refs"),B.emit("mounted"),B.clean("mounted:refs"),B.clean("mounted")},createElement:S,useState:function(e){if(m.target){var t=m.target.instance;return t.id||(t.state?function(e,t){for(var n in t)a(t,n)&&(e[n]=t[n])}(t.state[r],e):t.state=N(e)),t.state}throw new Error("please invoke useState at top level in a component")},useContext:function(e){if(m.target)throw new Error("please invoke useContext at top level outside all components");return N(e)},useRefs:function(){if(m.target)return m.target.instance.refs;throw new Error("please invoke useRefs at top level in a component")},onBeforeMount:function(e){if(!m.target)throw new Error("please invoke onBeforeMount at top level in a component");m.target.instance.id||e()},onMounted:function(e){if(!m.target)throw new Error("please invoke onMounted at top level in a component");m.target.instance.id||B.on("mounted",e)},onBeforeUpdate:function(e){if(!m.target)throw new Error("please invoke onBeforeUpdate at top level in a component");var t=m.target.instance;t.id||B.on("mounted",function(){return B.on("before-update:"+t.id,e)})},onUpdated:function(e){if(!m.target)throw new Error("please invoke onUpdated at top level in a component");var t=m.target.instance;t.id||B.on("mounted",function(){return B.on("updated:"+t.id,e)})},onBeforeUnMount:function(e){if(!m.target)throw new Error("please invoke onBeforeUnMount at top level in a component");var t=m.target.instance;t.id||B.on("mounted",function(){return B.on("before-unmount:"+t.id,e)})},onUnMounted:function(e){if(!m.target)throw new Error("please invoke onUnMounted at top level in a component");var t=m.target.instance;t.id||B.on("mounted",function(){return B.on("unmounted:"+t.id,e)})}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Kurge=t()});
